---
title: '性价比最高的服务部署方式：使用 frp 将本地服务映射到外网'
date: '2024-12-1'
cover: ''
tag: ['frp', 'self-host', 'homelab']
---

云服务的价格存在一个甜品点，当服务器的配置超过某个阈值后，性价比就会急剧下降。  
比如 Amazon AWS lightsail，2核2GB 的价格是`12刀`一个月，2核心4GB 的价格是`24刀`一个月，整整贵了一倍！  

如果需要部署的服务对网络延迟不敏感，有一个好方法是使用「内网穿透」，通过比较低配的云服务器，将本地机器的服务暴露出去。  

我的本地服务器是一台 Intel 10900 64GB 的淘汰开发机，云服务器的配置则是 2核4GB，作为代理机来说绰绰有余。  
两台机器均安装最新的 Ubuntu 24.04。
最终要实现的效果是将本地服务器作为 CI/CD 的运行平台。  

## 网络测试
为了保证服务稳定，首先要测试本地服务器和云服务器（后续简称为`本地`和`云`）之间的网络情况。  
这里使用`mtr`作为测试工具，MTR（My Traceroute）是一款网络诊断工具，结合了 traceroute 和 ping 命令的功能。它用于分析主机到目标地址之间的网络路径和延迟情况。  
关于mtr更详细的内容，可以查看[Cloudflare的这篇文章](https://www.cloudflare.com/learning/network-layer/what-is-mtr/)。  

使用`mtr -c 10 -r 192.0.2.1`命令进行测试，其中`-c 10`命令表示发送10个探测包，-r表示生成测试报告，执行结果如下：
```bash
# 下面的 ip 均进行了替换
homelab@server:~$ mtr -c 10 -r 192.0.2.1
Start: 2024-11-30T23:52:53+0800
HOST: homelab                     Loss%   Snt   Last   Avg  Best  Wrst StDev
  1.|-- 192.0.2.1                  0.0%    10    0.8   1.0   0.5   1.8   0.4
  2.|-- 192.0.2.2                  0.0%    10    4.8   5.8   3.3   8.5   2.2
  3.|-- 192.0.2.3                  0.0%    10    6.3   6.8   1.7  34.5   9.8
  4.|-- 192.0.2.4                  60.0%    10    9.6  11.5   9.3  17.6   4.1
  5.|-- 192.0.2.5                  90.0%    10   33.2  33.2  33.2  33.2   0.0
  6.|-- 192.0.2.6                  0.0%    10   34.6  34.0  31.2  37.7   1.9
  7.|-- 192.0.2.7                  0.0%    10   39.3  36.4  31.6  39.3   2.5
  8.|-- 192.0.2.8                  0.0%    10   75.5  72.4  69.6  76.1   2.4
  9.|-- 192.0.2.9                  0.0%    10   75.6  75.5  72.8  84.1   3.4
 10.|-- 192.0.2.10                 0.0%    10   75.9  73.4  70.4  79.1   2.7
 11.|-- ???                       100.0    10    0.0   0.0   0.0   0.0   0.0
 12.|-- ???                       100.0    10    0.0   0.0   0.0   0.0   0.0
 13.|-- ???                       100.0    10    0.0   0.0   0.0   0.0   0.0
 14.|-- 192.0.2.11                 30.0%    10   73.2  75.3  72.0  85.2   4.8
        192.0.2.12                     
        192.0.2.13                     
        192.0.2.14                     
 15.|-- 192.0.2.15                 0.0%    10   72.2  71.6  70.5  73.2   0.9
```

对于上面的结果，进行一个简单的解读：

| 跳数 | 主机地址              | 丢包率 | 发送包数 | 最后延迟 (ms) | 平均延迟 (ms) | 最好延迟 (ms) | 最坏延迟 (ms) | 标准差 (ms) |
|------|---------------------|--------|----------|---------------|----------------|----------------|----------------|-------------|
| 1    | 192.0.2.1           | 0.0%   | 10       | 0.8           | 1.0            | 0.5            | 1.8            | 0.4         |
| 2    | 192.0.2.2           | 0.0%   | 10       | 4.8           | 5.8            | 3.3            | 8.5            | 2.2         |
| 3    | 192.0.2.3           | 0.0%   | 10       | 6.3           | 6.8            | 1.7            | 34.5           | 9.8         |
| 4    | 192.0.2.4           | 60.0%   | 10       | 9.6           | 11.5           | 9.3            | 17.6           | 4.1         |
| 5    | 192.0.2.5           | 90.0%   | 10       | 33.2          | 33.2           | 33.2           | 33.2           | 0.0         |
| 6    | 192.0.2.6           | 0.0%   | 10       | 34.6          | 34.0           | 31.2           | 37.7           | 1.9         |
| 7    | 192.0.2.7           | 0.0%   | 10       | 39.3          | 36.4           | 31.6           | 39.3           | 2.5         |
| 8    | 192.0.2.8           | 0.0%   | 10       | 75.5          | 72.4           | 69.6           | 76.1           | 2.4         |
| 9    | 192.0.2.9           | 0.0%   | 10       | 75.6          | 75.5           | 72.8           | 84.1           | 3.4         |
| 10   | 192.0.2.10          | 0.0%   | 10       | 75.9          | 73.4           | 70.4           | 79.1           | 2.7         |
| 11   | ???                 | 100.0% | 10       | 0.0           | 0.0            | 0.0            | 0.0            | 0.0         |
| 12   | ???                 | 100.0% | 10       | 0.0           | 0.0            | 0.0            | 0.0            | 0.0         |
| 13   | ???                 | 100.0% | 10       | 0.0           | 0.0            | 0.0            | 0.0            | 0.0         |
| 14   | 192.0.2.14          | 30.0%   | 10       | 73.2          | 75.3           | 72.0           | 85.2           | 4.8         |
| 15   | 192.0.2.15          | 0.0%   | 10       | 72.2          | 71.6           | 70.5           | 73.2           | 0.9         |

1. **丢包情况**：
   - 第一跳和第二跳无丢包，连接良好。
   - 第四跳有 60% 的丢包，可能表明该路由器存在问题或网络拥堵。
   - 第五跳丢包率高达 90%，是连接中的主要瓶颈。
   - 第十一、十二和十三跳均显示 100% 丢包，表示这些节点无法访问。

> 「跳」（hop）指的是数据包从一个网络设备（如路由器、交换机等）传输到下一个网络设备的过程。每经过一个设备，就算作一次跳。

2. **延迟情况**：
   - 第一跳的延迟非常低（平均 1.0 ms），说明本地网络连接良好。
   - 第四跳的平均延迟为 11.5 ms，虽然丢包较高，但延迟仍然在合理范围内。
   - 到达目标 IP 地址（192.0.2.15）的平均延迟为 71.6 ms，表现良好。

报告中有一些异常，比如 11、12、13 跳显示 ??? 而且丢包率百分百，后续却可以正常传输，表示拿不到中间节点的信息，一般是因为这个节点被设置成不回应 ICMP 包，但是能够正常转发包。   

同理，节点4、5丢包率比后面的节点还要高，这可能是中间节点对 ICMP 协议限速，导致中间节点可能看到 packet loss，但是后面的节点没有，或者后面节点 loss 的数量比前面少。  
这种情况下，永远相信后面的节点。  
原理很简单，mtr 和 traceroute 的原理类似，都是发送 TTL=1,2,3,4,5… 的包探测出 IP 包的路由节点，然后去 ping 这些节点。所以这里的丢包率是从本地依次 ping 这些节点的丢包率。
假如中间某个节点发生了丢包，那么它后面的节点一定会丢包，因为后面节点要可达必须经过中间的节点。  
像上面图中那种情况，第 2 个节点有 10% 的丢包率，后面的反而没有，说明节点 2 并不是真正地丢包，只是对你的 ping 丢了包，实际的包没有丢。

在排除这些「异常节点」后才是真正的网络报告。

## 内网穿透工具：frp
frp 是一个开源的跨平台内网穿透工具，Go语言编写，支持 TCP, UDP, HTTP, HTTPS 等多种协议，提供了加密、压缩，身份认证，代理限速，负载均衡等众多能力。此外，还可以通过 xtcp 实现 P2P 通信。  

### 部署
在[Github Release](https://github.com/fatedier/frp/releases)页面，根据自己的机型下载最版的frp。  
解压后，文件夹中包含：  
```bash
.
├── LICENSE
├── frpc       # frp client，表示本地服务器
├── frpc.toml  # client 配置文件
├── frps       # frp server，表示云服务器
└── frps.toml  # server 配置文件
```
将frps和frps.toml上传到云服务器，frpc和frpc.toml上传到本地服务器。  

```bash
# 上传到云服务器
scp frps frps.toml root@192.0.2.15:/root
# 上传到本地服务器
scp frpc frpc.toml homelab@192.0.2.14:/home/homelab
```

### 配置
frp 会读取目录下的配置文件，实现内网穿透的配置文件示例如下：
```toml
# frps.toml
[common]
bind_port = 7000

# frpc.toml
[common]
server_addr = "192.0.2.15"
server_port = 7000
```

## 强化安全性

# 参考
- [使用 mtr 检查网络问题，以及注意事项 - 卡瓦邦噶！](https://www.kawabangga.com/posts/4275)
- [如何使用MTR诊断网络问题 - HelloDog](https://wsgzao.github.io/post/mtr/)
- [Can't run mtr from install - Homebrew - Discussion #5311](https://github.com/orgs/Homebrew/discussions/5311)

